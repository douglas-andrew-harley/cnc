; This G-code probes the Y0 position from front.

o<probe-y-from-front> sub

; Configuration Variables
#<probe_max_distance> = 1.0 ; In
#<backoff_rate> = 20.0 ; In/s
#<fast_probe_rate> = 10.0 ; In/s
#<fast_backoff> = 0.05 ; In
#<slow_probe_rate> = 3.75 ; In/s
#<slow_backoff> = 0.5 ; In
#<probe_bar_thick> = 0.125 ; In

M101 ; Ask user about the probe diameter

; Internal variables
#<bit_offset> = #<_hal[probe-radius]> ; In
#<probe_dir> = 1 ; -1 to probe towards negative co-ords, 1 to probe towards positive

M70 ; Save modal state
G91 ; Relative/incremental movements
G20 ; Inches

M100 P1; Enable probe input mask
G38.3 Y[#<probe_dir> * #<probe_max_distance>] F[#<fast_probe_rate>] ; Probe at fast speed to get close
M100 P0; Disable probe input mask
o<probe-y-from-front-if1> if [#5070 NE 1]
    M72 ; Restore modal state
    ; MSG, Probing failed!
    o<probe-y-from-front> return
o<probe-y-from-front-if1> endif
G01 Y[-#<probe_dir> * #<fast_backoff>] F[#<backoff_rate>]; Back off

M100 P1; Enable probe input mask
G38.3 Y[#<probe_dir> * #<probe_max_distance>] F[#<slow_probe_rate>] ; Probe at slow speed; more precise
M100 P0; Disable probe input mask
o<probe-y-from-front-if2> if [#5070 NE 1]
    M72 ; Restore modal state
    ; MSG, Probing failed!
    o<probe-y-from-front> return
o<probe-y-from-front-if2> endif
G01 Y[-#<probe_dir> * #<slow_backoff>] F[#<backoff_rate>]; Back off

; Set G54 instead of G92 since that is consistent
; with what AXIS "Touch Off" buttons do
; Set current G5x offset so current co-ordinate is:
G10 L20 P0 Y[-#<probe_dir> * [#<probe_bar_thick> + #<slow_backoff> + #<bit_offset>]]

M72 ; Restore modal state

o<probe-y-from-front> endsub
